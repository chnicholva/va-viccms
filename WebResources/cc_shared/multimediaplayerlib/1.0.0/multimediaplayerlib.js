/** @license Copyright (c) Microsoft Corporation. All rights reserved. */
(function(){"use strict";var Playback=WinJS.Class.define(function(){},{_mediaFactory:null,_initHtmlElements:null,container:null,playBackViewModel:null,properties:{},isInitialized:false,initView:function(container,properties){if(MscrmCommon.ControlUtils.Object.isNullOrUndefined(container))throw"Playback container cannot be null.";if(MscrmCommon.ControlUtils.Object.isNullOrUndefined(this._mediaFactory))throw"Inherited Playback class must set the _mediaFactory property.";this.playbackViewModel=new MscrmControls.Multimedia.PlaybackViewModel(this,properties,this._mediaFactory,container);this.container=container;this.properties=properties;if(MscrmCommon.ControlUtils.Object.isNullOrUndefined(properties.time))this.properties.time=ko.observable(0);if(MscrmCommon.ControlUtils.Object.isNullOrUndefined(properties.duration))this.properties.duration=ko.observable(0);this._initHtmlElements(container);this.playbackViewModel.init();var mediaSource=this.properties.media();ko.applyBindings(this.playbackViewModel,container);this.playbackViewModel._onChangeMedia(mediaSource);this._initSeekBar&&this._initSeekBar(container);this.isInitialized=true},setProperty:function(propertyName,value){this.properties[propertyName]=value},disposeView:function(){this.properties=null;this.playbackViewModel.dispose();this.playbackViewModel=null;this.isInitialized=false;ko.cleanNode(this.container);this.container=null},onChangeAutoStart:function(evt){if(MscrmCommon.ControlUtils.Object.isNullOrUndefined(evt))throw"onChangeAutoStart called without argument: evt";if(evt.newValue===null)return;this._playOrPause(evt.newValue)},onChangeLoop:function(evt){if(MscrmCommon.ControlUtils.Object.isNullOrUndefined(evt))throw"onChangeLoop called without argument: evt";if(evt.newValue===null)this.playbackViewModel._mediaObject().loop=false;else this.playbackViewModel._mediaObject().loop=evt.newValue},onChangeStartTime:function(evt){if(MscrmCommon.ControlUtils.Object.isNullOrUndefined(evt))throw"onChangeStartTime called without argument: evt";if(evt.newValue===null)return;if(evt.newValue<this.properties.duration())this.playbackViewModel._mediaObject().currentTime=evt.newValue;else this.playbackViewModel._mediaObject().currentTime=this.properties.duration()},onChangeShowControls:function(evt){if(MscrmCommon.ControlUtils.Object.isNullOrUndefined(evt))throw"onChangeShowControls called without argument: evt";if(evt.newValue===null)this.playbackViewModel._mediaObject().showControls=false;else this.playbackViewModel._mediaObject().showControls=evt.newValue},onChangeStart:function(evt){if(MscrmCommon.ControlUtils.Object.isNullOrUndefined(evt))throw"onChangeStart called without argument: evt";if(evt.newValue===null)return;if(evt.newValue)this.playbackViewModel.play();else this.playbackViewModel.pause()},_playOrPause:function(newValue){this.properties.autoStart()&&newValue&&this.playbackViewModel.play();this.properties.autoPause&&!newValue&&this.playbackViewModel.pause()}},{});WinJS.Namespace.define("MscrmControls.Multimedia",{Playback:Playback})})();(function(){"use strict";var Media=WinJS.Class.derive(MscrmControls.CommonAppMagic.Core.KnockoutDisposable,function(){MscrmControls.CommonAppMagic.Core.KnockoutDisposable.call(this);this.beforePause=new EventObject;this.beforePlay=new EventObject;this.durationChanged=new EventObject;this.ended=new EventObject;this.error=new EventObject;this.metadataLoaded=new EventObject;this.paused=new EventObject;this.playing=new EventObject;this.timeUpdated=new EventObject},{_disabled:false,beforePause:null,beforePlay:null,durationChanged:null,ended:null,error:null,metadataLoaded:null,paused:null,playing:null,timeUpdated:null,loadAsync:function(mediaId,startTime,container){return WinJS.Promise.wrap(true)},play:function(){},pause:function(){},width:{"set":function(value){}},height:{"set":function(value){}},poster:{"set":function(src){}},currentTime:{"get":function(){return 0},"set":function(value){}},disabled:{"get":function(){return this._disabled},"set":function(value){this._disabled=value}},duration:{"get":function(){return 0}},isPaused:{"get":function(){return true}},loop:{"get":function(){return false},"set":function(value){}},showControls:{"get":function(){return true},"set":function(value){}},template:{"get":function(){return "null"}}}),EventObject=WinJS.Class.define(function(){this._listeners=[];this._invokeFn=this._invoke.bind(this)},{_listeners:null,_invokeFn:null,subscribe:function(listener){this._listeners.push(listener)},unsubscribe:function(listener){var index=this._listeners.indexOf(listener);index>=0&&this._listeners.splice(index,1)},invoke:{"get":function(){return this._invokeFn}},_invoke:function(){var args=arguments;this._listeners.forEach(function(listener){listener.apply(null,args)})}});WinJS.Namespace.define("MscrmControls.Multimedia",{EventObject:EventObject,Media:Media})})();WinJS.Namespace.define("MscrmControls.Multimedia.Constants",{zIndex:{topmost:1001},OrientationLandscape:"landscape",OrientationPortrait:"portrait",Audio:{timerVisibilityThreshold:300,volumeVisibilityThreshold:215,seekbarVisibilityThreshold:90,audioMinPlayerWidth:65,verticalVolumeThreshold:165},Video:{videoMinPlayerWidth:240,videoMinPlayerHeight:130,defaultScaleFactor:3},Controls:{onChangeMediaThrottle:1e3,controlsFadeDelay:3e3,volumeSliderHideDelay:1500,toggleSwitchHandleSize:10}});(function(){"use strict";var E_UNEXPECTED=-2147418113,E_NOTIMPL=-2147467263;ko.bindingHandlers.mediaattr={update:function(element,valueAccessor,allBindingsAccessor,viewModel,bindingContext){var attrMap=ko.utils.unwrapObservable(valueAccessor());for(var attrName in attrMap)if(attrMap.hasOwnProperty(attrName)){var attrValue=ko.utils.unwrapObservable(attrMap[attrName]);try{element[attrName]=attrValue}catch(err){if(!(err instanceof Error&&(err.number===E_UNEXPECTED||err.number===E_NOTIMPL)))throw err}}}};var PlaybackViewModel=WinJS.Class.derive(MscrmControls.CommonAppMagic.Core.KnockoutDisposable,function(playback,properties,mediaFactory,container){MscrmControls.CommonAppMagic.Core.KnockoutDisposable.call(this);this.track("_eventTracker",new MscrmControls.CommonAppMagic.Core.EventTracker);this._mediaFactory=mediaFactory;this.trackObservable("_mediaObject",ko.observable(mediaFactory.createInitial()));this._container=container;this._playback=playback;this._properties=properties;this._onBeforePauseHandler=this._onBeforePause.bind(this);this._onBeforePlayHandler=this._onBeforePlay.bind(this);this._onDurationChangeHandler=this._onDurationChange.bind(this);this._onEndedHandler=this._onEnded.bind(this);this._onErrorHandler=this._onError.bind(this);this._onLoadedMetadataHandler=this._onLoadedMetadata.bind(this);this._onPauseHandler=this._onPause.bind(this);this._onPlayHandler=this._onPlay.bind(this);this._onTimeUpdateHandler=this._onTimeUpdate.bind(this);var that=this;this.track("isDisabled",ko.computed(function(){return that._properties.isDisabled()},this));this.track("Fill",ko.computed(function(){if(this.isDisabled())return "rgba(119, 119, 119, 1)";return this.properties.fill},this));this.track("_isMediaThrottling",ko.observable(false));this.track("_isPlaying",ko.observable(false))},{isDisabled:null,audioControlsVisibility:null,_mediaFactory:null,_mediaObject:null,_container:null,_playback:null,_properties:null,_onBeforePauseHandler:null,_onBeforePlayHandler:null,_onDurationChangeHandler:null,_onEndedHandler:null,_onErrorHandler:null,_onLoadedMetadataHandler:null,_onPauseHandler:null,_onPlayHandler:null,_onTimeUpdateHandler:null,_lastTimeOutput:null,_timeOutputInterval:500,_throttledMedia:null,_isMediaThrottling:null,_isPlaying:null,_media:null,_mediaValue:null,mediaObject:{"get":function(){return this._mediaObject?this._mediaObject():null}},properties:{"get":function(){return this._properties}},isPlaying:{"get":function(){return this._isPlaying()}},isDisabledDiv:{"get":function(){return this.isDisabled()}},init:function(){this.trackAnonymous(this.isDisabled.subscribe(function(newValue){this._mediaObject().disabled=!!newValue},this));this.track("audioControlsVisibility",ko.computed(function(){return {playPause:true,timers:this._properties.width()>MscrmControls.Multimedia.Constants.Audio.timerVisibilityThreshold,volume:this._properties.width()>MscrmControls.Multimedia.Constants.Audio.volumeVisibilityThreshold,seekbar:this._properties.width()>MscrmControls.Multimedia.Constants.Audio.seekbarVisibilityThreshold,verticalVolume:this._properties.height()>MscrmControls.Multimedia.Constants.Audio.verticalVolumeThreshold}},this));this._addPlayBackElementListeners();if(this._playback.onChangeMediaThrottleTime>0){this.track("_throttledMedia",ko.computed(this.properties.media).extend({throttle:this._playback.onChangeMediaThrottleTime}));this.track("_media",ko.computed(function(){return this._isMediaThrottling()?this._throttledMedia():this.properties.media()},this));this.trackAnonymous(this._media.subscribe(this._onChangeMedia,this))}else this.trackAnonymous(this.properties.media.subscribe(this._onChangeMedia,this))},dispose:function(){this._removePlayBackElementListeners();MscrmControls.CommonAppMagic.Core.KnockoutDisposable.prototype.dispose.call(this)},play:function(){this._mediaObject().play()},pause:function(){this._mediaObject().pause()},_onTimeUpdate:function(){var shouldOutputTime=function(){var now=(new Date).getTime();if(this._lastTimeOutput===null){this._lastTimeOutput=now;return true}if(now-this._lastTimeOutput>this._timeOutputInterval){this._lastTimeOutput=now;return true}return false}.bind(this);if(this._mediaObject().isPaused||shouldOutputTime())if(this._mediaObject().currentTime>this.properties.duration())this.properties.time(this.properties.duration());else this.properties.time(this._mediaObject().currentTime)},_onEnded:function(){this._lastTimeOutput=null;this.pause()},_onPause:function(){this.properties.paused(true);if(this._mediaObject().currentTime>this.properties.duration())this.properties.time(this.properties.duration());else this.properties.time(this._mediaObject().currentTime)},_onPlay:function(){this.properties.paused(false)},_onChangeMedia:function(newValue){this.dispatchEvent("onMediaChanged");if(newValue===this._mediaValue)return;this._mediaValue=newValue;this._setMedia(this._mediaFactory.create("null"));var mediaParseResult=this._mediaFactory.parse(newValue),media=this._mediaFactory.create(mediaParseResult.template);this._setMedia(media);var startTime=this.properties.startTime||mediaParseResult.startTime||0;media.loadAsync(mediaParseResult.mediaId,startTime,this._container).then(function(){media.loop=!!this.properties.loop();media.showControls=!!this.properties.showControls;media.disabled=this.properties.isDisabled();var newStartTime=this.properties.startTime||mediaParseResult.startTime||0;if(newStartTime!==startTime)media.currentTime=newStartTime;media.width=this.properties.width();media.height=this.properties.height()}.bind(this));this.properties.paused(media.isPaused);this.properties.time(media.currentTime)},_setMedia:function(newMedia){var oldMedia=this._mediaObject();this._removePlayBackElementListeners();this._mediaObject(newMedia);oldMedia.dispose();this._addPlayBackElementListeners()},_addPlayBackElementListeners:function(){var media=this._mediaObject();media.beforePause.subscribe(this._onBeforePauseHandler);media.beforePlay.subscribe(this._onBeforePlayHandler);media.durationChanged.subscribe(this._onDurationChangeHandler);media.metadataLoaded.subscribe(this._onLoadedMetadataHandler);media.timeUpdated.subscribe(this._onTimeUpdateHandler);media.ended.subscribe(this._onEndedHandler);media.paused.subscribe(this._onPauseHandler);media.error.subscribe(this._onErrorHandler);media.playing.subscribe(this._onPlayHandler)},_removePlayBackElementListeners:function(){var media=this._mediaObject();media.beforePause.unsubscribe(this._onBeforePauseHandler);media.beforePlay.unsubscribe(this._onBeforePlayHandler);media.durationChanged.unsubscribe(this._onDurationChangeHandler);media.metadataLoaded.unsubscribe(this._onLoadedMetadataHandler);media.timeUpdated.unsubscribe(this._onTimeUpdateHandler);media.ended.unsubscribe(this._onEndedHandler);media.paused.unsubscribe(this._onPauseHandler);media.error.unsubscribe(this._onErrorHandler);media.playing.unsubscribe(this._onPlayHandler)},_onError:function(){this._onDurationChange()},_onBeforePause:function(){this._isPlaying(false)},_onBeforePlay:function(){this._isPlaying(true)},_onDurationChange:function(){var dur=this._mediaObject().duration;if(!isFinite(dur))typeof this.properties.duration()!=="undefined"&&this.properties.duration(0);else typeof this.properties.duration()!=="undefined"&&this.properties.duration(dur)},_onLoadedMetadata:function(){this.dispatchEvent("onLoadedMetadata");$(this._container).removeClass("appmagic-video-collapse");var start=this.properties.start,autoStart=this.properties.autoStart(),media=this._properties.media,stopwatch=this._properties.stopwatch;!MscrmCommon.ControlUtils.Object.isNullOrUndefined(media)&&media!==""&&!MscrmCommon.ControlUtils.Object.isNullOrUndefined(stopwatch)&&stopwatch.stop();if(start||autoStart)this.play();else this.pause()}},{});WinJS.Class.mix(PlaybackViewModel,WinJS.Utilities.eventMixin);WinJS.Namespace.define("MscrmControls.Multimedia",{PlaybackViewModel:PlaybackViewModel})})();(function(){"use strict";var E_UNEXPECTED=-2147418113,E_NOTIMPL=-2147467263,HtmlMedia=WinJS.Class.derive(MscrmControls.Multimedia.Media,function(){MscrmControls.Multimedia.Media.call(this);this._mediaElement=new NullMediaElement;this._audioElementEnabled=ko.observable(true);this._loop=ko.observable(false);this._showControls=ko.observable(true);this._volume=ko.observable(.5);this._overlayVisible=ko.observable(true);this._wasVolumeButtonRecentlyClicked=ko.observable(false);this._wasMouseRecentlyMoved=ko.observable(false);this._isMuted=ko.observable(false);this._seekBarDuration=ko.observable(this._getTimeFormattedString(0));this._seekBarTime=ko.observable(this._getTimeFormattedString(0));this._seekBarValue=ko.observable(0);this.durationChanged.subscribe(this._onDurationChanged.bind(this));this.timeUpdated.subscribe(this._onTimeUpdated.bind(this))},{_container:null,_mediaElement:null,_audioElementEnabled:null,_overlayVisible:null,_loop:null,_showControls:null,_wasVolumeButtonRecentlyClicked:null,_wasMouseRecentlyMoved:null,_seekBar:null,_seekBarValue:null,_seekBarTime:null,_isMuted:null,_volume:null,_isScrubbing:false,_hideControlsTimeout:MscrmControls.Multimedia.Constants.Controls.controlsFadeDelay,_hideControlsTimeoutHandle:null,_hideVolumeTimeout:MscrmControls.Multimedia.Constants.Controls.volumeSliderHideDelay,_hideVolumeTimeoutHandle:null,onClick:function(){this.onPointerMove()},onClickPlayPauseButton:function(){if(this.disabled)return;if(!this.isPaused)this.pause();else this.play()},onClickVolumeMuteButton:function(){this._isMuted(!this._isMuted())},onClickVolumeButton:function(){var wasVolumeButtonRecentlyClicked=this._wasVolumeButtonRecentlyClicked();this._wasVolumeButtonRecentlyClicked(!wasVolumeButtonRecentlyClicked)},_onDurationChanged:function(){var dur=this._mediaElement.duration;if(!isFinite(dur))this._seekBarDuration(this._getTimeFormattedString(0));else this._seekBarDuration(this._getTimeFormattedString(Math.round(dur)))},onKeyPressed:function(data,evt){if(this.disabled)return false;return true},onPaused:function(){!this._mediaElement.ended&&this.paused.invoke()},onPointerMove:function(){if(this.disabled)return;this._wasMouseRecentlyMoved(true);if(this._hideControlsTimeoutHandle!==null){this._overlayVisible(true);clearTimeout(this._hideControlsTimeoutHandle)}var that=this;this._hideControlsTimeoutHandle=setTimeout(function(){that._wasMouseRecentlyMoved(false);that._wasVolumeButtonRecentlyClicked(false);that._hideControlsTimeoutHandle=null;that._overlayVisible(false)},this._hideControlsTimeout);return true},onPlaybackSeekBarPointerDown:function(data,evt){this._isScrubbing=true;return true},onPlaybackSeekBarPointerUp:function(data,evt){this._isScrubbing=false;this._updateTime(this._seekBarValue());return true},_onTimeUpdated:function(){!this._isScrubbing&&this._refreshSeekBarValues()},audioElementEnabled:{"get":function(){return this._audioElementEnabled()}},controlsIsVisible:{"get":function(){return this._wasMouseRecentlyMoved()||this._seekBarValue()===this.seekBarMin}},isMuted:{"get":function(){return this._isMuted()}},isVolumeContainerVisible:{"get":function(){return this._wasMouseRecentlyMoved()&&this._wasVolumeButtonRecentlyClicked()}},minVolume:0,maxVolume:100,seekBarMin:0,seekBarMax:100,overlayVisible:{"get":function(){return this._overlayVisible()}},seekBarDuration:{"get":function(){return this._seekBarDuration()}},seekBarTime:{"get":function(){return this._seekBarTime()}},seekBarValue:{"get":function(){return this._seekBarValue}},volume:{"get":function(){return this._volume()},"set":function(value){this._volume(value)}},volumeSliderValue:{"get":function(){var sliderValue=this._volume()*(this.maxVolume-this.minVolume)+this.minVolume;return sliderValue.toString()},"set":function(value){var intVal=parseInt(value);this._volume(intVal/(this.maxVolume-this.minVolume));this._isMuted(intVal===this.minVolume)}},_getTimeFormattedString:function(seconds){var secs=seconds%60,minutes=(seconds-secs)/60,mins=minutes%60,hours=(minutes-mins)/60;if(secs<10)secs="0"+secs.toString();if(mins<10)mins="0"+mins.toString();if(hours<10)hours="0"+hours.toString();var result=MscrmCommon.ControlUtils.String.Format("{0}:{1}:{2}",hours,mins,secs);return result},_recreatePlaybackElement:function(){this._audioElementEnabled(false);this._audioElementEnabled(true);this._updateMediaElement()},_refreshSeekBarValues:function(){var fraction=this.currentTime/this.duration;this._seekBarTime(this._getTimeFormattedString(Math.round(this.currentTime)));if(!isFinite(fraction))this._seekBarValue(this.seekBarMin);else this._seekBarValue(this.seekBarMin+fraction*(this.seekBarMax-this.seekBarMin))},_setPlaybackSrc:function(src){try{this._mediaElement.src=src}catch(e){}},_updateMediaElement:function(){var videoElements=this._container.getElementsByTagName("video");if(videoElements.length===1)this._mediaElement=videoElements[0];else{var audioElements=this._container.getElementsByTagName("audio");this._mediaElement=audioElements[0]}},_updateTime:function(value){var duration=this.duration,currTime=duration*(value-this.seekBarMin)/(this.seekBarMax-this.seekBarMin);if(isFinite(currTime))this.currentTime=currTime},loadAsync:function(mediaId,startTime,container){this._container=container;this._updateMediaElement();var oldValue="";oldValue=this._mediaElement.src;this._setPlaybackSrc("");this._recreatePlaybackElement();var newValue=mediaId||"";this._setPlaybackSrc(newValue);this._seekBarDuration(this._getTimeFormattedString(0));this._seekBarTime(this._getTimeFormattedString(0));this._seekBarValue(this.seekBarMin);if(startTime!==0)this.currentTime=startTime;return WinJS.Promise.wrap(true)},play:function(){this.beforePlay.invoke();try{this._mediaElement.play()}catch(err){if(!(err instanceof Error&&err.number===this.E_UNEXPECTED))throw err}},pause:function(){this.beforePause.invoke();try{this._mediaElement.pause()}catch(err){if(!(err instanceof Error&&err.number===this.E_UNEXPECTED))throw err}},currentTime:{"get":function(){return this._mediaElement.currentTime},"set":function(value){if(this._mediaElement.readyState>=HTMLMediaElement.HAVE_METADATA)this._mediaElement.currentTime=value;else{var loadedMetadataHandler=function(){this._mediaElement.currentTime=value;this._mediaElement.removeEventListener("loadedmetadata",loadedMetadataHandler)}.bind(this);this._mediaElement.addEventListener("loadedmetadata",loadedMetadataHandler)}}},duration:{"get":function(){return this._mediaElement.duration}},isPaused:{"get":function(){return this._mediaElement.paused}},loop:{"get":function(){return this._loop()},"set":function(value){this._loop(value)}},showControls:{"get":function(){return this._showControls()},"set":function(value){this._showControls(value)}},dispose:function(){MscrmControls.CommonAppMagic.Core.KnockoutDisposable.prototype.dispose.call(this);this._mediaElement&&this._setPlaybackSrc("")}}),NullMediaElement=WinJS.Class.define(function(){},{play:function(){},pause:function(){},currentTime:{"get":function(){return 0},"set":function(value){}},duration:{"get":function(){return 0}},loop:{"get":function(){return false},"set":function(value){}},paused:{"get":function(){return true}},src:{"get":function(){return ""},"set":function(value){}},readyState:{"get":function(){return HTMLMediaElement.HAVE_METADATA}}}),AudioHtmlMedia=WinJS.Class.derive(HtmlMedia,function(){HtmlMedia.call(this)},{template:{"get":function(){return "audio"}}}),VideoHtmlMedia=WinJS.Class.derive(HtmlMedia,function(){HtmlMedia.call(this)},{template:{"get":function(){return "video"}}});WinJS.Namespace.define("MscrmControls.Multimedia",{AudioHtmlMedia:AudioHtmlMedia,VideoHtmlMedia:VideoHtmlMedia})})();(function(){"use strict";var AudioPlayback=WinJS.Class.derive(MscrmControls.Multimedia.Playback,function(){this._mediaFactory=new MscrmControls.Multimedia.AudioMediaFactory;MscrmControls.Multimedia.Playback.call(this)},{_initHtmlElements:function(container){}},{});WinJS.Namespace.define("MscrmControls.Multimedia",{AudioPlayback:AudioPlayback})})();(function(){"use strict";var AzureVideoMedia=WinJS.Class.derive(MscrmControls.Multimedia.VideoHtmlMedia,function(){MscrmControls.Multimedia.VideoHtmlMedia.call(this);this._invokeDurationChangedHandler=this._invokeDurationChanged.bind(this);this._invokeEndHandler=this._invokeEnd.bind(this);this._invokeErrorHandler=this._invokeError.bind(this);this._invokePauseHandler=this._invokePause.bind(this);this._invokePlayHandler=this._invokePlay.bind(this);this._invokeTimeUpdatedHandler=this._invokeTimeUpdated.bind(this);this._onMetaDataLoadedHandler=this._onMetaDataLoaded.bind(this);this._onReloadHandler=this._onReload.bind(this)},{_azurePlayerContainer:null,_isMetadataLoaded:null,_startTime:0,_currentMedia:null,_invokeDurationChangedHandler:null,_invokeEndHandler:null,_invokeErrorHandler:null,_invokePauseHandler:null,_invokePlayHandler:null,_invokeTimeUpdatedHandler:null,_metaDataLoadedHandler:null,_loadMedia:function(mediaId){this._azurePlayerContainer.src([{src:mediaId,type:"application/vnd.ms-sstr+xml"}]);this._currentMedia=mediaId},_checkMediaSupport:function(err){if(!(err instanceof Error&&err.number===this.E_UNEXPECTED))throw err},_invokeDurationChanged:function(){this.durationChanged.invoke()},_invokeEnd:function(){this.ended.invoke();this._loadMedia(this._currentMedia);this._azurePlayerContainer.addEventListener("loadeddata",this._onReloadHandler)},_invokeError:function(){this.error.invoke()},_invokePause:function(){if(!this._azurePlayerContainer.ended()&&!this._azurePlayerContainer.seeking()){this.beforePause.invoke();this.paused.invoke()}},_invokePlay:function(){this.beforePlay.invoke();this.playing.invoke()},_invokeTimeUpdated:function(){this.timeUpdated.invoke()},_onMetaDataLoaded:function(){this._azurePlayerContainer.removeEventListener("loadeddata",this._onMetaDataLoadedHandler);this._isMetadataLoaded=true;this._startTime>0&&this._azurePlayerContainer.currentTime(this._startTime);this._addListeners();this._invokeDurationChanged();this.metadataLoaded.invoke()},_onReload:function(){this._azurePlayerContainer.removeEventListener("loadeddata",this._onReloadHandler);this.loop&&this._azurePlayerContainer.play()},width:{"set":function(value){this._azurePlayerContainer.width(value)}},height:{"set":function(value){this._azurePlayerContainer.height(value)}},currentTime:{"get":function(){if(this._isMetadataLoaded)return this._azurePlayerContainer.currentTime();else return 0},"set":function(value){if(this._isMetadataLoaded)this._azurePlayerContainer.currentTime(value);else{var loadedMetadataHandler=function(){this._azurePlayerContainer.currentTime(value);this._azurePlayerContainer.removeEventListener("loadeddata",loadedMetadataHandler)}.bind(this);this._azurePlayerContainer.addEventListener("loadeddata",loadedMetadataHandler)}}},showControls:{"get":function(){return this._showControls()},"set":function(value){this._azurePlayerContainer.controls(value);this._showControls(value)}},disabled:{"get":function(){return this._disabled},"set":function(value){if(value)this._azurePlayerContainer.controls(false);else this._azurePlayerContainer.controls(this.showControls);this._disabled=value}},duration:{"get":function(){if(this._isMetadataLoaded)return this._azurePlayerContainer.duration();else return 0}},onClickPlayPauseButton:function(){if(this.disabled||this.showControls)return;if(!this.isPaused)this.pause();else this.play()},isPaused:{"get":function(){return this._azurePlayerContainer.paused()}},pause:function(){this.beforePause.invoke();try{this._azurePlayerContainer.pause()}catch(err){this._checkMediaSupport(err)}},play:function(){try{this._azurePlayerContainer.play()}catch(err){this._checkMediaSupport(err)}},poster:{"set":function(src){this._azurePlayerContainer.poster(src)}},template:{"get":function(){return "azure"}},_addListeners:function(){this._azurePlayerContainer.addEventListener("durationchange",this._invokeDurationChangedHandler);this._azurePlayerContainer.addEventListener("ended",this._invokeEndHandler);this._azurePlayerContainer.addEventListener("error",this._invokeErrorHandler);this._azurePlayerContainer.addEventListener("pause",this._invokePauseHandler);this._azurePlayerContainer.addEventListener("play",this._invokePlayHandler);this._azurePlayerContainer.addEventListener("timeupdate",this._invokeTimeUpdatedHandler)},_removeListeners:function(){this._azurePlayerContainer.removeEventListener("durationchange",this._invokeDurationChangedHandler);this._azurePlayerContainer.removeEventListener("ended",this._invokeEndHandler);this._azurePlayerContainer.removeEventListener("error",this._invokeErrorHandler);this._azurePlayerContainer.removeEventListener("pause",this._invokePauseHandler);this._azurePlayerContainer.removeEventListener("play",this._invokePlayHandler);this._azurePlayerContainer.removeEventListener("timeupdate",this._invokeTimeUpdatedHandler);this._azurePlayerContainer.removeEventListener("loadeddata",this._onReloadHandler);this._azurePlayerContainer.removeEventListener("loadeddata",this._onMetaDataLoadedHandler)},loadAsync:function(mediaId,startTime,container){this._container=container;this._updateMediaElement();this._isMetadataLoaded=false;this._startTime=startTime;var useNativeControls=true,techOrder=["azureHtml5JS","html5"],isAndroid=navigator.userAgent.match(/Android/i);if(isAndroid){useNativeControls=false;techOrder=["html5","azureHtml5JS"]}this._azurePlayerContainer=amp(this._mediaElement,{techOrder:techOrder,nativeControlsForTouch:useNativeControls,preload:"auto"});this._azurePlayerContainer.addEventListener("loadeddata",this._onMetaDataLoadedHandler);this._loadMedia(mediaId);return WinJS.Promise.wrap(true)},dispose:function(){if(this.isDisposed)return;if(this._azurePlayerContainer!==null){this._removeListeners();this._azurePlayerContainer.dispose()}MscrmControls.CommonAppMagic.Core.KnockoutDisposable.prototype.dispose.call(this)}});WinJS.Namespace.define("MscrmControls.Multimedia",{AzureVideoMedia:AzureVideoMedia})})();(function(){"use strict";var FramedVideoMedia=WinJS.Class.derive(MscrmControls.Multimedia.Media,function(template,mediaDefaults){MscrmControls.Multimedia.Media.call(this);this._mediaDefaults=mediaDefaults;this._template=this._mediaDefaults.getTemplateName()},{_element:null,_mediaId:0,_showControls:true,_template:null,_mediaDefaults:null,_autoHide:true,dispose:function(){MscrmControls.CommonAppMagic.Core.KnockoutDisposable.prototype.dispose.call(this);if(MscrmCommon.ControlUtils.Object.isNullOrUndefined(this._element)){$(this._element).remove();this._element=null}this._template=null;this._channel=null},loadAsync:function(mediaId,startTime,container){this._mediaId=mediaId;var elementContainer=container.getElementsByClassName(this._template)[0];$(elementContainer).empty();this._element=this._mediaDefaults.createFrameElement(mediaId,startTime,this._autoHide,this._showControls);$(this._element).appendTo(elementContainer);var that=this;$(this._element).load(function(){that.metadataLoaded.invoke()});return WinJS.Promise.wrap(true)},showControls:{"get":function(){return this._showControls},"set":function(value){this._showControls=value}},template:{"get":function(){return this._template}}});WinJS.Namespace.define("MscrmControls.Multimedia",{FramedVideoMedia:FramedVideoMedia})})();(function(){"use strict";var VideoMediaFactory=WinJS.Class.define(function(){},{create:function(template){switch(template){case "video":return new MscrmControls.Multimedia.VideoHtmlMedia;case "youtube-video":return new MscrmControls.Multimedia.FramedVideoMedia(template,new MscrmControls.Multimedia.YoutubeDefaults);case "azure":return new MscrmControls.Multimedia.AzureVideoMedia;case "null":return new MscrmControls.Multimedia.Media}return new Media},createInitial:function(){return new MscrmControls.Multimedia.VideoHtmlMedia},parse:function(uri){var a=document.createElement("a");a.href=uri;if(/^https?:$/i.test(a.protocol)&&(/^((?:www\.)|(?:m\.))?youtube(\-nocookie)?\.[a-z]{2,3}(\.[a-z]{2,3})?$/i.test(a.hostname)||/^(?:www\.)?youtu\.be$/i.test(a.hostname))){var videoId,startTime;if(a.pathname.indexOf("watch")!==-1){var linkParameters=this._parseYouTubeLink(a.search);videoId=linkParameters.v;startTime=this._parseYouTubeLinkStartTime(a.search)}else{videoId=this._parseYouTubeEmbedLink(a.pathname);startTime=this._parseYouTubeLinkStartTime(a.search)}if(typeof videoId==="string"&&videoId.length>0&&startTime!==-1)return {mediaId:videoId,template:"youtube-video",startTime:startTime}}if(this._isAzureMediaServiceUrl(a.href))return {mediaId:uri,template:"azure",startTime:0};return {mediaId:uri,template:"video",startTime:0}},_isAzureMediaServiceUrl:function(mediaUrl){mediaUrl=mediaUrl.toLowerCase();var guidTestPattern=/[0-9A-Fa-f]{8}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{12}/i;return MscrmControls.CommonAppMagic.Utilities.Utility.endsWith(mediaUrl,".ism/manifest")&&guidTestPattern.test(mediaUrl)&&(mediaUrl.indexOf("http://")===0||mediaUrl.indexOf("https://")===0)},_parseYouTubeEmbedLink:function(pathname){if(pathname!==""){var videoIdArray=pathname.split("/"),videoId=videoIdArray[videoIdArray.length-1].split("?")[0];return videoId}return ""},_parseYouTubeLink:function(search){var results={};if(search.length>0&&(search[0]==="?"||search[0]==="#")){var parameters=search.substr(1).split("&");parameters.forEach(function(parameter){var parts=parameter.split("=",2),key=parts[0],value=decodeURIComponent(parts.length===2?parts[1]:"");if(typeof results[key]==="undefined")results[key]=value})}return results},_parseYouTubeLinkStartTime:function(hash){if(typeof hash==="string"){var hashParams=this._parseYouTubeLink(hash);if(typeof hashParams.t==="string"){var timeString=hashParams.t,totalSeconds=0;if(timeString.length===0)return -1;var split=timeString.split("h");if(split.length>2)return -1;else if(split.length===2){var hours=Number(split[0]);if(isNaN(hours)||hours<0)return -1;totalSeconds+=hours*60*60;timeString=split[1]}split=timeString.split("m");if(split.length>2)return -1;else if(split.length===2){var minutes=Number(split[0]);if(isNaN(minutes)||minutes<0)return -1;totalSeconds+=minutes*60;timeString=split[1]}split=timeString.split("s");if(split.length===1||split.length===2&&split[1]===""){var seconds=Number(split[0]);if(isNaN(seconds)||seconds<0)return -1;totalSeconds+=seconds}else return -1;return totalSeconds}}return 0}});WinJS.Namespace.define("MscrmControls.Multimedia",{VideoMediaFactory:VideoMediaFactory})})();(function(){"use strict";ko.bindingHandlers.observableProperty={update:function(element,valueAccessor,allBindingsAccessor,viewModel,bindingContext){var propertyMap=ko.utils.unwrapObservable(valueAccessor());for(var propertyName in propertyMap)if(propertyMap.hasOwnProperty(propertyName)){var wrapped=propertyMap[propertyName],propertyValue=ko.utils.unwrapObservable(wrapped),propertyTarget=element[propertyName];if(propertyTarget)propertyTarget(propertyValue);else{element[propertyName]=ko.observable(propertyValue);ko.isObservable(wrapped)&&element[propertyName].subscribe(function(newValue){this(newValue)},wrapped)}}}};ko.bindingHandlers.seekbar={init:function(element){if(!element.renderedControl)return {controlsDescendantBindings:true};else return {}},update:function(element,valueAccessor){var doRender=ko.utils.unwrapObservable(valueAccessor());if(doRender===element.renderedControl)return;if(element.renderedControl){ko.virtualElements.emptyNode(element);element.renderedControl=null}if(doRender){element.renderedControl=doRender;element.innerHTML='<div class="appmagic-seekbar-container-body" touch-action="none">\t\t\t<div class="appmagic-seekbar-container">\t\t\t\t<div class="appmagic-seekbar-track">\t\t\t\t\t<div class="appmagic-seekbar-fill" data-bind="style: { width: seekBarFillWidth }"></div>\t\t\t\t</div>\t\t\t\t<div class="appmagic-seekbar-scroller-thumb" data-bind="style: { width: seekBarFillWidth }">\t\t\t\t\t<img class="appmagic-seekbar-thumb" src="#" data-bind="attr: { src: seekBarThumbSrc }" />\t\t\t\t</div>\t\t\t</div>\t\t</div>';element.seekBar=new MscrmControls.Multimedia.SeekBar(element)}}};var seekBarThumbSrcUrl="data:image/svg+xml;base64,PHN2ZyB2ZXJzaW9uPSIxLjEiIGlkPSJMYXllcl8xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4PSIwcHgiIHk9IjBweCIJIHdpZHRoPSIxMHB4IiBoZWlnaHQ9IjEwcHgiIHZpZXdCb3g9IjAgMCAxMCAxMCIgZW5hYmxlLWJhY2tncm91bmQ9Im5ldyAwIDAgMTAgMTAiIHhtbDpzcGFjZT0icHJlc2VydmUiPjxjaXJjbGUgZmlsbD0iI0ZGRkZGRiIgY3g9IjUiIGN5PSI1IiByPSI1Ii8+PC9zdmc+",seekBarThumbSelectedSrcUrl="data:image/svg+xml;base64,PHN2ZyB2ZXJzaW9uPSIxLjEiIGlkPSJMYXllcl8xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4PSIwcHgiIHk9IjBweCIJIHdpZHRoPSIxMHB4IiBoZWlnaHQ9IjEwcHgiIHZpZXdCb3g9IjAgMCAxMCAxMCIgZW5hYmxlLWJhY2tncm91bmQ9Im5ldyAwIDAgMTAgMTAiIHhtbDpzcGFjZT0icHJlc2VydmUiPjxjaXJjbGUgZmlsbD0iI0ZGRkZGRiIgY3g9IjUiIGN5PSI1IiByPSI1Ii8+PC9zdmc+",seekBarTrackClassSelector=".appmagic-seekbar-track",seekBarThumbClassSelector=".appmagic-seekbar-thumb",seekBarFillSelector=".appmagic-seekbar-fill",SeekBar=WinJS.Class.define(function(element){this._element=element;this._seekBarTrack=this._element.querySelector(seekBarTrackClassSelector);this._seekBarThumb=this._element.querySelector(seekBarThumbClassSelector);this._seekBarFill=this._element.querySelector(seekBarFillSelector);this._onPointerEventHandler=this._onPointerEvent.bind(this);this._element.addEventListener("pointerdown",this._onPointerEventHandler,true);this._element.addEventListener("pointerup",this._onPointerEventHandler,true);this._element.addEventListener("pointermove",this._onPointerEventHandler,true);this._element.addEventListener("pointercancel",this._onPointerEventHandler,true);this._seekBarThumbSrc=ko.observable(seekBarThumbSrcUrl);this._seekBarFillWidth=ko.observable();this._updateSeekBarFillWidth(element.value());this._element.value.subscribe(this._updateSeekBarFillWidth,this);this._element.min.subscribe(this._updateSeekBarFillWidth,this);this._element.max.subscribe(this._updateSeekBarFillWidth,this);ko.applyBindings(this,element.children[0])},{_element:null,_seekBarTrack:null,_seekBarThumb:null,_seekBarThumbSrc:null,_kseekBarFillWidth:null,_isManipulating:false,_onPointerEventHandler:null,_updateSeekBarFillWidth:function(newValue){var min=this._element.min(),max=this._element.max();this._seekBarFillWidth(this.clamp((newValue-min)/(max-min)*100,0,100).toString()+"%")},seekBarFillWidth:{"get":function(){return this._seekBarFillWidth()}},seekBarThumbSrc:{"get":function(){return this._seekBarThumbSrc()}},clamp:function(value,minimum,maximum){value=Math.max(value,minimum);return Math.min(value,maximum)},_updateValue:function(e){var offsetX=e.pageX-this._element.getBoundingClientRect().left;if(e.target===this._seekBarThumb)offsetX=this._seekBarThumb.offsetLeft+offsetX+this._seekBarThumb.width/2;var fractionWidth=offsetX/this._seekBarTrack.offsetWidth,min=this._element.min(),max=this._element.max();this._element.value(this.clamp(fractionWidth*(max-min)+min,min,max))},_onPointerEvent:function(e){switch(e.type){case "pointerdown":e.preventDefault();this._updateValue(e);this._isManipulating=true;this._seekBarThumbSrc(seekBarThumbSelectedSrcUrl);WinJS.Utilities._setPointerCapture(this._element,e.pointerId);break;case "pointerup":case "pointercancel":e.preventDefault();this._isManipulating=false;e.cancelBubble=true;this._seekBarThumbSrc(seekBarThumbSrcUrl);WinJS.Utilities._releasePointerCapture(this._element,e.pointerId);break;case "pointermove":e.preventDefault();this._isManipulating&&this._updateValue(e);e.cancelBubble=true;break}return true}},{});WinJS.Namespace.define("MscrmControls.Multimedia",{SeekBar:SeekBar})})();(function(){"use strict";var VideoPlayback=WinJS.Class.derive(MscrmControls.Multimedia.Playback,function(){this._mediaFactory=new MscrmControls.Multimedia.VideoMediaFactory;MscrmControls.Multimedia.Playback.call(this)},{_maxHeight:null,_minHeight:null,_changingImage:false,_seekBar:null,_initHtmlElements:function(container){this._maxHeight=this.properties.maximumHeight();this._minHeight=this.properties.minimumHeight();MscrmControls.CommonAppMagic.Utilities.Utility.createOrSetPrivate(this.playbackViewModel,"hideControls",ko.observable(false));MscrmControls.CommonAppMagic.Utilities.Utility.createOrSetPrivate(this.playbackViewModel,"isEditing",ko.observable(false));MscrmControls.CommonAppMagic.Utilities.Utility.createOrSetPrivate(this.playbackViewModel,"isFullscreen",ko.observable(false));MscrmControls.CommonAppMagic.Utilities.Utility.createOrSetPrivate(this.playbackViewModel,"onClickFullscreenButton",this.onClickFullscreenButton.bind(this));MscrmControls.CommonAppMagic.Utilities.Utility.createOrSetPrivate(this.playbackViewModel,"onKeyUp",this._onKeyUp.bind(this));MscrmControls.CommonAppMagic.Utilities.Utility.createOrSetPrivate(this.playbackViewModel,"poster",ko.observable(""));MscrmControls.CommonAppMagic.Utilities.Utility.createOrSetPrivate(this.playbackViewModel,"scaleFactor",ko.observable(1));MscrmControls.CommonAppMagic.Utilities.Utility.createOrSetPrivate(this,"_onMediaChangedHandler",this._onMediaChanged.bind(this));this.playbackViewModel.addEventListener("onMediaChanged",this._onMediaChangedHandler);this._updateControls()},_onMediaChanged:function(){this._exitFullScreen()},_exitFullScreen:function(){this.playbackViewModel.isFullscreen()&&this.onClickFullscreenButton()},disposeView:function(container){this._exitFullScreen();this.playbackViewModel.removeEventListener("onMediaChanged",this._onMediaChangedHandler);MscrmControls.Multimedia.Playback.prototype.disposeView.call(this,container)},_onKeyUp:function(e){if(!this.playbackViewModel.isFullscreen())throw"Expected the view to be full screen.";e.keyCode===27&&this.playbackViewModel.onClickFullscreenButton();e.stopPropagation()},onClickFullscreenButton:function(){var shouldGoFullscreen=!this.playbackViewModel.isFullscreen(),isAndroid=navigator.userAgent.match(/Android/i);if(MscrmCommon.FullscreenHelper.supportsFullscreenApi)this._updateFullscreenUsingApi(shouldGoFullscreen,isAndroid);else this._updateFullscreenUsingStyling(shouldGoFullscreen);!isAndroid&&this.playbackViewModel.isFullscreen(shouldGoFullscreen)},onChangeHeight:function(evt){if(!MscrmCommon.ControlUtils.Object.isNullOrUndefined(this.playbackViewModel))this.playbackViewModel.mediaObject.height=this.properties.height();this._updateControls()},onChangeWidth:function(evt){if(!MscrmCommon.ControlUtils.Object.isNullOrUndefined(this.playbackViewModel))this.playbackViewModel.mediaObject.width=this.properties.width();this._updateControls()},_updateFullscreenUsingApi:function(isFullscreen,isAndroid){if(isFullscreen){document.addEventListener(MscrmCommon.EventConstants.KeyUp,this.playbackViewModel.onKeyUp,true);var fullscreenTarget=isAndroid?$(this.container).find("video")[0]:this.container;MscrmCommon.FullscreenHelper.requestFullscreen(fullscreenTarget)}else{document.removeEventListener(MscrmCommon.EventConstants.KeyUp,this.playbackViewModel.onKeyUp,true);MscrmCommon.FullscreenHelper.exitFullscreen()}},_updateFullscreenUsingStyling:function(isFullscreen){if(isFullscreen){document.addEventListener(MscrmCommon.EventConstants.KeyUp,this.playbackViewModel.onKeyUp,true);MscrmCommon.FullscreenHelper.requestFullscreenUsingStyling(this.container)}else{document.removeEventListener(MscrmCommon.EventConstants.KeyUp,this.playbackViewModel.onKeyUp,true);MscrmCommon.FullscreenHelper.exitFullscreenUsingStyling(this.container)}},_updateControls:function(){this._updateScaleFactor()},_updateScaleFactor:function(){var height=this.properties.height();if(this._maxHeight===this._minHeight){this.playbackViewModel.scaleFactor(MscrmControls.Multimedia.Constants.Video.defaultScaleFactor);return}this.playbackViewModel.scaleFactor((height-this._minHeight)*(2/(this._maxHeight-this._minHeight))+3)}},{});WinJS.Namespace.define("MscrmControls.Multimedia",{VideoPlayback:VideoPlayback})})();(function(){"use strict";var YoutubeDefaults=WinJS.Class.define(function(){},{_template:"youtube-video",getTemplateName:function(){return this._template},getClassName:function(){return "appmagic-video-playback-"+this._template},createFrameElement:function(videoId,startTime,autoHideSeekbar,showControls){var element=document.createElement("iframe");element.src=MscrmCommon.ControlUtils.String.Format("//www.youtube.com/embed/{0}?modestbranding=1&showinfo=0&start={1}&rel=0&autohide={2}&controls={3}&iv_load_policy=3",videoId===null?"":videoId,startTime,autoHideSeekbar?"1":"0",showControls?"1":"0");element.setAttribute("frameborder","0");element.setAttribute("allowfullscreen","");element.setAttribute("style","min-height: 200px;");element.setAttribute("sandbox","allow-forms allow-pointer-lock allow-same-origin allow-scripts");return element}});WinJS.Namespace.define("MscrmControls.Multimedia",{YoutubeDefaults:YoutubeDefaults})})();(function(){"use strict";var NativeVideoPlayback=WinJS.Class.derive(MscrmControls.Multimedia.Playback,function(){this._mediaFactory=new MscrmControls.Multimedia.VideoMediaFactory;MscrmControls.Multimedia.Playback.call(this)},{_initHtmlElements:function(container){},_exitFullScreen:function(){MscrmCommon.FullscreenHelper.fullscreenElement&&MscrmCommon.FullscreenHelper.exitFullscreen()},disposeView:function(container){this._exitFullScreen();MscrmControls.Multimedia.Playback.prototype.disposeView.call(this,container)}},{});WinJS.Namespace.define("MscrmControls.Multimedia",{NativeVideoPlayback:NativeVideoPlayback})})()